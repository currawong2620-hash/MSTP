# üü• TECH SPEC ‚Äî PositionPolicyManager v1.1

## Virtual SL/TP by Price (Points)

**–ü—Ä–æ–µ–∫—Ç:** Trading Platform (MQL5)
**–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞:** Strategy / Replaceable Roles
**–†–æ–ª—å:** `PositionPolicyManager`
**–í–µ—Ä—Å–∏—è —Ä–æ–ª–∏:** **v1.1**
**–†–µ–≤–∏–∑–∏—è:** **REV B (AUDIT-RESOLVED)**
**–°—Ç–∞—Ç—É—Å:** Reference / Baseline
**–Ø–∑—ã–∫:** —Å—Ç—Ä–æ–≥–æ MQL5

**–§–∞–π–ª —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

```
modules/Strategy/PositionPolicyManager.mqh
```

---

## 1. –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–î–û–õ–ñ–ù–ê —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å**:

1. **SSP v1.1**
2. **ARCHITECTURE_ROLE_MODEL v1.1**
3. **ARCHITECTURE_DATA_FLOW_MODEL v1.1**
4. **CONTRACT_LEXICON v1.1**
5. **ROLE_CALL_CONTRACTS_MQL5 v0.1**
6. **NAMING_RULES v1.0**

---

## 2. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏

`PositionPolicyManager` (PPM) ‚Äî —ç—Ç–æ **–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–ª–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–æ–∑–∏—Ü–∏–∏**.

–í –≤–µ—Ä—Å–∏–∏ **v1.1** —Ä–æ–ª—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

* **–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö StopLoss / TakeProfit –ø–æ —Ü–µ–Ω–µ (points)**
* –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è MT5 SL/TP
* –±–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–π –ª–æ–≥–∏–∫–∏
* –±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

PPM ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ**, –≥–¥–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ **–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –≤—ã—Ö–æ–¥–µ –ø–æ —Ü–µ–Ω–µ**.

---

## 3. –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Ä–æ–ª–∏ (–ó–ê–ö–†–ï–ü–õ–Å–ù, –ù–ï –ú–ï–ù–Ø–¢–¨)

```mq5
int PositionPolicyManager_Run(
   const Intent &intent,
   const Snapshot &snapshot,
   const Feedback &feedback,
   PolicyAdjustedIntent &out_policy_intents[]
);
```

---

## 4. –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Snapshot (—Å—Ç—Ä–æ–≥–æ)

–í **v1.1 (Path 1)** PPM **–ú–û–ñ–ï–¢ —á–∏—Ç–∞—Ç—å –¢–û–õ–¨–ö–û**:

```mq5
snapshot.position.has_position
snapshot.position.direction
snapshot.position.volume
snapshot.position.entry_price
snapshot.market.bid
snapshot.market.ask
```

–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:

* –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω—É–ª—è–º–∏
* **–ù–ï —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –ª–æ–≥–∏–∫–µ**
* **–ù–ï –¥–æ–ª–∂–Ω—ã —á–∏—Ç–∞—Ç—å—Å—è**

---

## 5. –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

### 5.1. –ï–¥–∏–Ω–∏—Ü—ã

–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ SL/TP –∑–∞–¥–∞—é—Ç—Å—è –≤ **points**.

```
1 point = _Point
```

–†–∞–∑—Ä–µ—à–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `_Point` **—Ç–æ–ª—å–∫–æ –∫–∞–∫ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ä–∞–∑–º–µ—Ä–∞ –ø—É–Ω–∫—Ç–∞**.
–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª—é–±—ã—Ö `SymbolInfo*`, `MarketInfo`, —Ç–æ—Ä–≥–æ–≤—ã—Ö API.

---

### 5.2. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã v1.1 (–∂—ë—Å—Ç–∫–æ)

```text
VIRTUAL_SL_POINTS = 100
VIRTUAL_TP_POINTS = 100
```

–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∏ **–Ω–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É—é—Ç—Å—è** –≤ v1.1.

---

## 6. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã—Ö–æ–¥–∞ (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï)

### 6.1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç Exit Policy

–ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ SL –∏–ª–∏ TP:

* **—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤—ã—Ö–æ–¥ –≤—Å–µ–≥–¥–∞**
* –≤—Ö–æ–¥–Ω–æ–π `Intent` **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é**
* –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è **—Ä–æ–≤–Ω–æ 1** `PolicyAdjustedIntent`
* –ø—Ä–∞–≤–∏–ª–æ: **Exit overrides Intent**

---

### 6.2. –°–µ–º–∞–Ω—Ç–∏–∫–∞ WANT_CLOSE (–ö–õ–Æ–ß–ï–í–û–ï –£–¢–û–ß–ù–ï–ù–ò–ï REV B)

–î–ª—è –ª—é–±–æ–≥–æ –≤—ã—Ö–æ–¥–∞:

```
PolicyAdjustedIntent.type      = WANT_CLOSE
PolicyAdjustedIntent.direction = 0
```

–ü—Ä–∏—á–∏–Ω—ã (–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã):

* CLOSE –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
* —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç CONTRACT_LEXICON
* —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç RiskArbiter TEST SPEC v1.0 (RA-3)
* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–∞–π–ø–ª–∞–π–Ω–∞

---

### 6.3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—Ö–æ–¥–æ–≤

–í v1.1 **—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ**:

* `0` –≤—ã—Ö–æ–¥–æ–≤
* `1` –≤—ã—Ö–æ–¥

–õ—é–±—ã–µ `2+` ‚Äî **–∑–∞–ø—Ä–µ—â–µ–Ω—ã**.

---

## 7. –ê–ª–≥–æ—Ä–∏—Ç–º (–ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π)

### 7.1. –®–∞–≥ 0 ‚Äî –æ—á–∏—Å—Ç–∫–∞ output

–í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞:

```mq5
ArrayResize(out_policy_intents, 0);
```

---

### 7.2. –®–∞–≥ 1 ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ SL/TP (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∑–∏—Ü–∏—è)

–ï—Å–ª–∏:

```mq5
snapshot.position.has_position == true
```

–≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞—Å—á—ë—Ç.

#### 7.2.1. –í—ã–±–æ—Ä —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã

```text
–ï—Å–ª–∏ direction > 0 (LONG)  ‚Üí current_price = snapshot.market.bid
–ï—Å–ª–∏ direction < 0 (SHORT) ‚Üí current_price = snapshot.market.ask
```

---

#### 7.2.2. –†–∞—Å—á—ë—Ç –¥–≤–∏–∂–µ–Ω–∏—è –≤ points

```text
move_points =
   (current_price - entry_price) / _Point
   * snapshot.position.direction
```

---

#### 7.2.3. –£—Å–ª–æ–≤–∏—è –≤—ã—Ö–æ–¥–∞

```text
move_points <= -VIRTUAL_SL_POINTS ‚Üí StopLoss
move_points >= +VIRTUAL_TP_POINTS ‚Üí TakeProfit
```

---

#### 7.2.4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–∞

–ï—Å–ª–∏ SL –∏–ª–∏ TP —Å—Ä–∞–±–æ—Ç–∞–ª:

```mq5
out_policy_intents[0].type      = WANT_CLOSE;
out_policy_intents[0].direction = 0;
out_policy_intents[0].volume    = snapshot.position.volume;
out_policy_intents[0].tag       = "POLICY_EXIT";
return 1;
```

---

### 7.3. –®–∞–≥ 2 ‚Äî –µ—Å–ª–∏ exit –ù–ï —Å—Ä–∞–±–æ—Ç–∞–ª

#### 7.3.1. `intent.type == NO_ACTION`

‚Üí `return 0`

---

#### 7.3.2. `intent.type == WANT_OPEN`

* –µ—Å–ª–∏ `snapshot.position.has_position == true` ‚Üí `return 0`
* –∏–Ω–∞—á–µ:

```mq5
out_policy_intents[0].type      = WANT_OPEN;
out_policy_intents[0].direction = intent.direction;
out_policy_intents[0].volume    = 0.10;
out_policy_intents[0].tag       = "POLICY_SINGLE";
return 1;
```

---

#### 7.3.3. `intent.type == WANT_CLOSE`

–í **v1.1** `WANT_CLOSE` –∏–∑ Intent **–í–°–ï–ì–î–ê –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è**:

‚Üí `return 0`

---

#### 7.3.4. `intent.type == WANT_HOLD`

‚Üí `return 0`

---

## 8. Feedback (—è–≤–Ω—ã–π –∑–∞–ø—Ä–µ—Ç –≤–ª–∏—è–Ω–∏—è)

`feedback`:

* **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**
* **–ù–ï –≤–ª–∏—è–µ—Ç** –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
* –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∏–≥–Ω–∞—Ç—É—Ä–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## 9. –î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º

–î–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Ö–æ–¥–æ–≤ (`Intent`, `Snapshot`, `Feedback`):

* –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π `count` –æ–¥–∏–Ω–∞–∫–æ–≤
* —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `out_policy_intents` –∏–¥–µ–Ω—Ç–∏—á–Ω–æ

---

## 10. –ó–∞–ø—Ä–µ—Ç—ã (–∂—ë—Å—Ç–∫–∏–µ)

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:

* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MT5 —Ç–æ—Ä–≥–æ–≤—ã–π API
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SymbolInfo*`, `MarketInfo`
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏ / –ø—Ä–æ—Ü–µ–Ω—Ç—ã
* —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏
* –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `2+` –≤—ã—Ö–æ–¥–æ–≤
* –∏–∑–º–µ–Ω—è—Ç—å Snapshot
* –≤—ã—á–∏—Å–ª—è—Ç—å SL/TP –≤–Ω–µ PPM

---

## 11. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–î–û–õ–ñ–ù–ê –ø—Ä–æ–π—Ç–∏**:

```
TEST SPEC ‚Äî PositionPolicyManager v1.1 (REV B)
```

–ë–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.

---

## 12. –°—Ç–∞—Ç—É—Å

**TECH SPEC ‚Äî PositionPolicyManager v1.1 (REV B): APPROVED / BASELINE**

---

### üîí –§–∏–∫—Å–∞—Ü–∏—è Master-Chat

–° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞:

* —Å–µ–º–∞–Ω—Ç–∏–∫–∞ `direction=0` –¥–ª—è `WANT_CLOSE` ‚Äî **–∑–∞–∫–æ–Ω**
* price-based SL/TP ‚Äî **—É–∑–∞–∫–æ–Ω–µ–Ω—ã**
* PPM v1.1 ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ª–æ–π exit –ø–æ —Ü–µ–Ω–µ**

---

