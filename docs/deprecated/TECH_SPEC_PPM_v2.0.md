# üü• TECH SPEC ‚Äî PositionPolicyManager v2.0

## Configurable Virtual SL / TP (Points)

**–ü—Ä–æ–µ–∫—Ç:** Trading Platform (MQL5)
**–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞:** Strategy / Replaceable Roles
**–†–æ–ª—å:** `PositionPolicyManager`
**–í–µ—Ä—Å–∏—è —Ä–æ–ª–∏:** **v2.0**
**–°—Ç–∞—Ç—É—Å:** Draft (Master-Chat)
**–Ø–∑—ã–∫:** —Å—Ç—Ä–æ–≥–æ MQL5

---

## 0. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ v2.0

`PositionPolicyManager v2.0` —Ä–∞—Å—à–∏—Ä—è–µ—Ç baseline v1.1,
–¥–æ–±–∞–≤–ª—è—è **–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ SL / TP**,
**–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–æ–ª–µ–π, –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏ Lexicon**.

> v2.0 **–ù–ï –≤–≤–æ–¥–∏—Ç —Ç—Ä–µ–π–ª–∏–Ω–≥**,
> **–ù–ï –≤–≤–æ–¥–∏—Ç –Ω–æ–≤—ã–µ —Ç–∏–ø—ã**,
> **–ù–ï –º–µ–Ω—è–µ—Ç —Å–µ–º–∞–Ω—Ç–∏–∫—É Intent / Decision / Feedback**.

---

## 1. –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–î–û–õ–ñ–ù–ê —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å**:

1. SSP v1.x
2. ARCHITECTURE_ROLE_MODEL v1.1
3. ARCHITECTURE_DATA_FLOW_MODEL v1.1
4. CONTRACT_LEXICON v1.2
5. ROLE_CALL_CONTRACTS_MQL5 v0.1
6. NAMING_RULES v1.0

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ç–∏–ø—ã, –ø–æ–ª—è –∏–ª–∏ enum.

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ä–æ–ª—å (—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è)

`PositionPolicyManager` ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ª–æ–π**, –≥–¥–µ:

* –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è —Ä–µ—à–µ–Ω–∏–µ –æ **–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –≤—ã—Ö–æ–¥–µ**
* —Ä–µ–∞–ª–∏–∑—É—é—Ç—Å—è **–≤—Å–µ —Ñ–æ—Ä–º—ã exit-policy**
* —Å—Ç—Ä–∞—Ç–µ–≥–∏—è **–ù–ï –∑–Ω–∞–µ—Ç**, –ø–æ—á–µ–º—É –ø—Ä–æ–∏–∑–æ—à—ë–ª –≤—ã—Ö–æ–¥

v2.0 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —ç—Ç–æ—Ç –ø—Ä–∏–Ω—Ü–∏–ø.

---

## 3. –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Ä–æ–ª–∏ (–ù–ï –ú–ï–ù–Ø–ï–¢–°–Ø)

```mq5
int PositionPolicyManager_Run(
   const Intent &intent,
   const Snapshot &snapshot,
   const Feedback &feedback,
   PolicyAdjustedIntent &out_policy_intents[]
);
```

‚ùó –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã ‚Üí –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è ROLE_CALL_CONTRACTS.

---

## 4. –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ù–û–í–û–ï –í v2.0)

### 4.1 –¢–∏–ø –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

SL / TP –∑–∞–¥–∞—é—Ç—Å—è **–∫–∞–∫ –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥—É–ª—è**
(–Ω–∞–ø—Ä–∏–º–µ—Ä `input int`), **–ù–ï –∫–∞–∫ –ø–æ–ª—è Snapshot**.

–ü—Ä–∏–º–µ—Ä (–Ω–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π):

```mq5
input int PPM_SL_POINTS;
input int PPM_TP_POINTS;
```

### 4.2 –°–µ–º–∞–Ω—Ç–∏–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

* –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è: **points**
* `0` –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Üí **–ø–æ–ª–∏—Ç–∏–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞**
* –ø–∞—Ä–∞–º–µ—Ç—Ä—ã **–ù–ï –º–æ–≥—É—Ç** –∏–∑–º–µ–Ω—è—Ç—å—Å—è –≤ runtime

---

## 5. –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Snapshot (–ñ–Å–°–¢–ö–û)

PPM v2.0 **–ú–û–ñ–ï–¢ —á–∏—Ç–∞—Ç—å –¢–û–õ–¨–ö–û**:

```
snapshot.position.has_position
snapshot.position.direction
snapshot.position.volume
snapshot.position.entry_price
snapshot.market.bid
snapshot.market.ask
```

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ —á–∏—Ç–∞—Ç—å:

* –∏—Å—Ç–æ—Ä–∏—é –±–∞—Ä–æ–≤
* –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
* time / is_new_bar
* floating_pnl (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

---

## 6. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã—Ö–æ–¥–∞ (–ö–†–ò–¢–ò–ß–ù–û)

### 6.1 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç exit-policy

–ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ SL –∏–ª–∏ TP:

* –≤—Ö–æ–¥–Ω–æ–π `Intent` **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è**
* —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è **–†–û–í–ù–û 1** `PolicyAdjustedIntent`
* –ø—Ä–∞–≤–∏–ª–æ: **Exit overrides Intent**

---

### 6.2 –°–µ–º–∞–Ω—Ç–∏–∫–∞ WANT_CLOSE (–ó–ê–ö–û–ù)

–î–ª—è –ª—é–±–æ–≥–æ –≤—ã—Ö–æ–¥–∞:

```
PolicyAdjustedIntent.type      = WANT_CLOSE
PolicyAdjustedIntent.direction = 0
```

–ü—Ä–∏—á–∏–Ω—ã:

* CLOSE –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
* —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å RiskArbiter v1.x
* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–∞–π–ø–ª–∞–π–Ω–∞

---

### 6.3 –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—Ö–æ–¥–æ–≤

–í v2.0 **—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ**:

* `0` –≤—ã—Ö–æ–¥–æ–≤
* `1` –≤—ã—Ö–æ–¥

`2+` ‚Üí –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.

---

## 7. –ê–ª–≥–æ—Ä–∏—Ç–º exit-policy (–ù–û–†–ú–ê–¢–ò–í–ù–û)

### 7.1 –£—Å–ª–æ–≤–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

Exit-policy **–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏**:

```
snapshot.position.has_position == true
```

---

### 7.2 –í—ã–±–æ—Ä —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã

```
LONG  ‚Üí snapshot.market.bid
SHORT ‚Üí snapshot.market.ask
```

---

### 7.3 –†–∞—Å—á—ë—Ç –¥–≤–∏–∂–µ–Ω–∏—è –≤ points

```
move_points =
   (current_price - entry_price) / _Point
   * snapshot.position.direction
```

---

### 7.4 –£—Å–ª–æ–≤–∏—è –≤—ã—Ö–æ–¥–∞

```
IF SL enabled AND move_points <= -SL_POINTS ‚Üí EXIT
IF TP enabled AND move_points >= +TP_POINTS ‚Üí EXIT
```

---

### 7.5 –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–∞

–ü—Ä–∏ EXIT:

```
type      = WANT_CLOSE
direction = 0
volume    = snapshot.position.volume
tag       = "POLICY_EXIT"
return 1
```

---

## 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ Intent (–µ—Å–ª–∏ EXIT –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)

* `NO_ACTION` ‚Üí `return 0`
* `WANT_OPEN`:

  * –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
  * –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –µ—Å—Ç—å ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
* `WANT_CLOSE` ‚Üí **–≤—Å–µ–≥–¥–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è**

(–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å v1.1)

---

## 9. Feedback (–Ø–í–ù–´–ô –ó–ê–ü–†–ï–¢)

`feedback`:

* **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**
* **–ù–ï –≤–ª–∏—è–µ—Ç** –Ω–∞ SL / TP
* –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** –¥–ª—è —Å–∏–≥–Ω–∞—Ç—É—Ä–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## 10. –î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º

–î–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö:

```
Intent
Snapshot
Feedback
–≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ SL / TP
```

‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç **–±–∏—Ç-–≤-–±–∏—Ç –∏–¥–µ–Ω—Ç–∏—á–µ–Ω**.

---

## 11. –ó–∞–ø—Ä–µ—Ç—ã (–ñ–Å–°–¢–ö–û)

PPM v2.0 **–ù–ï –ò–ú–ï–ï–¢ –ü–†–ê–í–ê**:

‚ùå —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏
‚ùå –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MT5 trade API
‚ùå –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SymbolInfo / MarketInfo
‚ùå –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å Snapshot
‚ùå —Ä–∞–∑–ª–∏—á–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã –≤—ã—Ö–æ–¥–∞ (SL vs TP)
‚ùå –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞

---

## 12. –°–≤—è–∑—å —Å –±—É–¥—É—â–∏–º–∏ –≤–µ—Ä—Å–∏—è–º–∏

* **v2.1**:

  * –¥–æ–±–∞–≤–ª—è–µ—Ç trailing stop
  * –ù–ï –º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç
* **v2.2**:

  * —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∂–∏–≤—ë—Ç –≤ DecisionMaker
  * PPM –æ—Å—Ç–∞—ë—Ç—Å—è exit-policy

---

## üîí –§–∏–∫—Å–∞—Ü–∏—è Master-Chat (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è)

–° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞:

1. SL / TP ‚Äî **policy, –Ω–µ strategy**
2. exit –∂–∏–≤—ë—Ç **–¢–û–õ–¨–ö–û** –≤ PPM
3. WANT_CLOSE –≤—Å–µ–≥–¥–∞ `direction = 0`
4. Strategy –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ exit
5. Executor –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–∏—á–∏–Ω –≤—ã—Ö–æ–¥–∞

---

