# üü• TECH SPEC ‚Äî PositionPolicyManager v1.0

## **ReferenceTrendBreak (PnL-based virtual exit policy)**

**–ü—Ä–æ–µ–∫—Ç:** Trading Platform (MQL5)
**–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞:** Strategy / Replaceable Roles
**–†–æ–ª—å:** `PositionPolicyManager`
**–í–µ—Ä—Å–∏—è:** v1.0
**–°—Ç–∞—Ç—É—Å:** Draft ‚Üí Master-Chat approval
**–Ø–∑—ã–∫:** —Å—Ç—Ä–æ–≥–æ MQL5

---

## 0. –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–û–ë–Ø–ó–ê–ù–ê** —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å:

1. **SSP v1.0**
2. **CONTRACT_LEXICON v1.x**
3. **NAMING_RULES v1.0**
4. **ROLE_CALL_CONTRACTS_MQL5 v0.1**
5. **Architecture Data Flow Model v1.0**

‚ùó
–ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–æ–ª–∏, —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—è, enum –∏–ª–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã.

---

## 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏

`PositionPolicyManager v1.0` —Ä–µ–∞–ª–∏–∑—É–µ—Ç **–ø–æ–ª–∏—Ç–∏–∫—É –≤–ª–∞–¥–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–µ–π**
–∏ **PnL-based virtual exit policy** –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ `ReferenceTrendBreak`.

–†–æ–ª—å:

* **–ù–ï** –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç —Ä—ã–Ω–æ–∫
* **–ù–ï** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—ã, —É—Ä–æ–≤–Ω–∏ –∏–ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
* **–ù–ï** —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º
* **–ù–ï** —Ö—Ä–∞–Ω–∏—Ç runtime state

–ï—ë –∑–∞–¥–∞—á–∞ ‚Äî **–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å `Intent` ‚Üí `PolicyAdjustedIntent`**
–Ω–∞ –æ—Å–Ω–æ–≤–µ **—Ñ–∞–∫—Ç–æ–≤ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏**.

---

## 2. –ü—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç (–ù–û–†–ú–ê–¢–ò–í–ù–û)

```mq5
int PositionPolicyManager_Run(
    const Intent &intent,
    const Snapshot &snapshot,
    const Feedback &feedback,
    PolicyAdjustedIntent &out_policy_intents[]
);
```

* —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞
* –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ `out_policy_intents`
* –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî `0` –∏–ª–∏ `1`

---

## 3. –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã (–°–¢–†–û–ì–û)

PositionPolicyManager **–ò–ú–ï–ï–¢ –ü–†–ê–í–û —á–∏—Ç–∞—Ç—å –¢–û–õ–¨–ö–û**:

* `Intent`
* `Snapshot.position.*`
* `Feedback`

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–ù–û–†–ú–ê–¢–ò–í–ù–û)

> `Feedback` **–ú–û–ñ–ï–¢ –±—ã—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω**,
> –Ω–æ **–ù–ï –î–û–õ–ñ–ï–ù –≤–ª–∏—è—Ç—å –Ω–∞ –≤—ã—Ö–æ–¥** –≤ –≤–µ—Ä—Å–∏–∏ v1.0.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ —á–∏—Ç–∞—Ç—å:

‚ùå `Snapshot.market.*`
‚ùå `Snapshot.time.*`
‚ùå `ExecutionResult`
‚ùå `Decision`
‚ùå —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—á—ë—Ç–∞ / —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

---

## 4. –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –≤—ã—Ö–æ–¥—ã

PositionPolicyManager **–ú–û–ñ–ï–¢ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å**:

* `0` `PolicyAdjustedIntent`
* `1` `PolicyAdjustedIntent` —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º:

  * `WANT_OPEN`
  * `WANT_CLOSE`

–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª–µ–µ —á–µ–º –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ **–ó–ê–ü–†–ï–©–ï–ù–û**.

---

## 5. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–ª–∞–¥–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–µ–π (–ö–†–ò–¢–ò–ß–ï–°–ö–ò)

### 5.1 Single Position Rule

```
–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ù–ï –ë–û–õ–ï–ï –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.
```

---

### 5.2 Open requires no position

```
IF snapshot.position.has_position == true
AND intent.type == WANT_OPEN
‚Üí produce 0 outputs
```

---

### 5.3 Close requires position (–ö–†–ò–¢–ò–ß–ù–û)

```
IF snapshot.position.has_position == false
AND intent.type == WANT_CLOSE
‚Üí produce 0 outputs
```

‚ùó
–ü—É—Å—Ç—ã–µ CLOSE **–ó–ê–ü–†–ï–©–ï–ù–´**.

---

## 6. Intent passthrough rules (–£–¢–û–ß–ù–ï–ù–û)

### 6.1 WANT_OPEN

```
IF intent.type == WANT_OPEN
AND snapshot.position.has_position == false
‚Üí propagate WANT_OPEN
```

---

### 6.2 WANT_CLOSE from Intent (–ó–ê–ü–†–ï–©–ï–ù–û)

> `WANT_CLOSE`, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π **–Ω–µ –∏–∑ exit policy**,
> **–ù–ï —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è**.

–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ
**–¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ PnL-based exit policy**.

---

### 6.3 NO_ACTION

```
IF intent.type == NO_ACTION
‚Üí produce 0 outputs
```

---

## 7. PnL-based virtual exit policy

### (NOT price-based SL/TP)

‚ùó
–≠—Ç–æ **exit policy**, –∞ –Ω–µ —Ç–æ—Ä–≥–æ–≤—ã–π —Å—Ç–æ–ø.
–û–Ω–∞ **–ù–ï** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—ã, —É—Ä–æ–≤–Ω–∏ –∏–ª–∏ —Ç–∏–∫-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.

---

### 7.1 Virtual Stop-Loss

```
IF snapshot.position.has_position == true
AND snapshot.position.floating_pnl <= -max_loss
‚Üí produce WANT_CLOSE
```

---

### 7.2 Virtual Take-Profit

```
IF snapshot.position.has_position == true
AND snapshot.position.floating_pnl >= take_profit
‚Üí produce WANT_CLOSE
```

---

## 8. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–∞–≤–∏–ª (–ù–û–†–ú–ê–¢–ò–í–ù–û)

–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è **–≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ**:

1. **Close requires position**
2. **PnL-based exit policy**
3. **Open requires no position**
4. **Intent passthrough (WANT_OPEN only)**

–ü–µ—Ä–≤–æ–µ —Å—Ä–∞–±–æ—Ç–∞–≤—à–µ–µ –ø—Ä–∞–≤–∏–ª–æ **–û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–¢ –æ–±—Ä–∞–±–æ—Ç–∫—É**.

---

## 9. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

PositionPolicyManager –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¢–û–õ–¨–ö–û –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã**:

* `max_loss`
* `take_profit`

‚ùó
**Runtime state –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏ –ù–ï –•–†–ê–ù–ò–¢–°–Ø.**
–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–≤–æ–¥–∏—Ç—Å—è –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ `Snapshot.position`.

---

## 10. –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (AUDIT)

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–û–ë–Ø–ó–ê–ù–ê**:

* –±—ã—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π
* –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Ö–æ–¥–∞—Ö
* –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–∑–æ–≤–æ–≤
* –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
* –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä—ã—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

---

## 11. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç—ã (–ñ–Å–°–¢–ö–û)

PositionPolicyManager **–ó–ê–ü–†–ï–©–ï–ù–û**:

‚ùå –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—ã
‚ùå –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
‚ùå –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ATR / MA
‚ùå —Ö—Ä–∞–Ω–∏—Ç—å state –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏
‚ùå –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `static` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚ùå –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `global` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚ùå –ø–æ—Ä–æ–∂–¥–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞
‚ùå –∑–Ω–∞—Ç—å –ø—Ä–æ Executor / –æ—Ä–¥–µ—Ä–∞
‚ùå –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å `Feedback`

–ù–∞—Ä—É—à–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –ø—É–Ω–∫—Ç–∞ = **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –¥–µ—Ñ–µ–∫—Ç**.

---

## 12. Visual Observability

–î–ª—è `PositionPolicyManager` **–û–ë–Ø–ó–ê–¢–ï–õ–ï–ù** Visual Tester,
–≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π **–¢–û–õ–¨–ö–û `PolicyAdjustedIntent`**.

–¢–µ—Å—Ç–µ—Ä:

* read-only
* –±–µ–∑ –ª–æ–≥–∏–∫–∏
* –±–µ–∑ –∑–Ω–∞–Ω–∏–π –æ —Ä—ã–Ω–∫–µ –∏–ª–∏ —Ä–∏—Å–∫–µ

---

## 13. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ (Gate v1.0)

–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π, –µ—Å–ª–∏:

* ‚ùè WANT_OPEN –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
* ‚ùè WANT_CLOSE –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ exit policy
* ‚ùè –ø—É—Å—Ç—ã–µ CLOSE –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã
* ‚ùè exit policy —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
* ‚ùè `Feedback` –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
* ‚ùè –Ω–µ—Ç runtime state
* ‚ùè SSP / Lexicon –Ω–µ –Ω–∞—Ä—É—à–µ–Ω—ã

---

## 14. Freeze Rule

–ü–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

> üîí **PositionPolicyManager v1.0 –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è**

–õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Üí **–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏**.

---

## 15. –ò—Ç–æ–≥

`PositionPolicyManager v1.0`:

* —Ä–µ–∞–ª–∏–∑—É–µ—Ç **—á–µ—Å—Ç–Ω—É—é PnL-based exit policy**
* —è–≤–ª—è–µ—Ç—Å—è **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º —è–∫–æ—Ä–µ–º** ReferenceStrategy
* –Ω–µ –ø–æ–¥–º–µ–Ω—è–µ—Ç –¥—Ä—É–≥–∏–µ —Ä–æ–ª–∏
* –≥–æ—Ç–æ–≤ –¥–ª—è end-to-end –≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

### üü¢ –°—Ç–∞—Ç—É—Å Master-Chat

> **TECH SPEC ‚Äî PositionPolicyManager v1.0
> –ì–û–¢–û–í–ê –ö –ü–†–ò–Å–ú–ö–ï –ò –†–ï–ê–õ–ò–ó–ê–¶–ò–ò**